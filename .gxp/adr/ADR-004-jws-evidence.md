# ADR-004: JWS (ES256) for Evidence Signing

## Status
Accepted

## Context
The ROSIE Middleware Platform validates compliance for pharmaceutical software systems under 21 CFR Part 11. A core requirement is cryptographic non-repudiation of evidence artifacts — proof that test results, verification outcomes, and compliance evidence have not been tampered with after generation.

RFC-001 specifies that evidence artifacts in the `.gxp/evidence/` directory must carry cryptographic signatures linking test results to specific specifications (SPEC artifacts) in the traceability chain. The signing mechanism must:

1. **Prove authenticity**: Verify that the evidence was generated by an authorized system or signer.
2. **Detect tampering**: Any modification to the evidence payload must invalidate the signature.
3. **Support non-repudiation**: Satisfy 21 CFR Part 11 SS 11.50 requirements for electronic signatures that cannot be repudiated by the signer.
4. **Be parseable**: The ROSIE Middleware must be able to decode and verify signatures during the Parse phase (REQ-004) without requiring the signing key.
5. **Be portable**: Evidence files must be self-contained and transferable between systems.

The system needed a standard, well-supported format for signed evidence artifacts.

## Decision
We chose **JSON Web Signature (JWS)** with the **ES256** algorithm (ECDSA using P-256 curve and SHA-256 hash) as the evidence signing format.

Key factors in the decision:

- **IETF standard (RFC 7515/7518)**: JWS is a widely adopted, formally specified standard for representing signed content. Using an IETF standard rather than a custom signing scheme reduces regulatory review burden — auditors can reference the RFC rather than evaluating proprietary cryptographic implementations.
- **ES256 (ECDSA P-256)**: Asymmetric algorithm that separates signing (private key) from verification (public key). The ROSIE Middleware only needs the public key to verify evidence, never the private key. This separation is critical for a system that scans third-party repositories — it should verify but never forge evidence.
- **Compact serialization**: JWS compact format (`header.payload.signature`) produces a single string that can be stored as a file in `.gxp/evidence/`. Each evidence artifact is a self-contained, verifiable unit.
- **Structured payload**: The JWS payload carries JSON-encoded evidence data (spec_id, verification_tier, test_results, timestamp, tool, version), enabling the Parse phase to extract structured metadata after base64url decoding.
- **Key rotation via `kid` header**: The JWS header includes a key ID (`kid`) field, allowing key rotation without invalidating previously signed evidence. Old evidence remains verifiable with the corresponding historical public key.
- **Library support**: `jose` (JavaScript) and equivalent libraries in Python, Java, Go, and .NET enable cross-platform verification. Scanned repositories can use any language to generate evidence.

## Consequences

**Positive:**
- Evidence artifacts are self-contained `.jws` files — no external signature database or PKI infrastructure required.
- Asymmetric verification — the ROSIE Middleware verifies evidence using public keys only. Signing keys remain with the originating system, supporting the principle of least privilege.
- Tamper detection is cryptographic — any byte change in the payload invalidates the ES256 signature, directly satisfying 21 CFR Part 11 SS 11.50 non-repudiation requirements.
- Standard format enables interoperability — any ROSIE-compliant tool can generate and verify evidence without proprietary dependencies.
- Small signature size — ES256 signatures are 64 bytes (vs. 256+ bytes for RSA-2048), keeping evidence files compact.
- Key rotation support via `kid` header — organizations can rotate signing keys without breaking verification of historical evidence.

**Negative:**
- Public key distribution — verifying organizations must obtain the signer's public key through a trusted channel. Currently handled via convention (public key in `.gxp/keys/` directory or well-known endpoint). No automated PKI is in place.
- No built-in revocation — if a signing key is compromised, there is no automated mechanism to revoke trust in evidence signed with that key. Requires manual intervention and re-signing of affected evidence. Mitigated by key rotation via `kid` and documented key compromise procedures.
- JWS compact format is not human-readable — the base64url-encoded payload requires tooling to inspect. Mitigated by the Parse phase extracting and storing decoded payload fields in PostgreSQL for human-readable access via the REST API.
- Single signature per artifact — JWS compact serialization supports one signature. If multi-party signing is needed in the future (e.g., author + reviewer co-signatures), migration to JWS JSON serialization (which supports multiple signatures) would be required.

## Alternatives Considered

### PGP/GPG Signatures
OpenPGP standard for signing evidence files.

- **Rejected because:** PGP signatures are designed for email and file-level signing with a web-of-trust model. The web-of-trust key distribution model adds complexity disproportionate to the use case. PGP signatures are typically attached to files as ASCII armor blocks rather than producing structured, parseable output. The ROSIE Middleware needs to extract structured evidence metadata (spec_id, test_results, verification_tier) from the signed payload — JWS's JSON payload is a natural fit; PGP's opaque signed content is not.

### XML Digital Signatures (XMLDSig)
W3C standard for XML-based digital signatures.

- **Rejected because:** The ROSIE Middleware ecosystem uses JSON and YAML throughout (YAML frontmatter for artifacts, JSON for API responses, JSON for evidence payloads). Introducing XML for signatures would add parser complexity and a format mismatch. XMLDSig is also known for canonicalization vulnerabilities and implementation complexity that has led to security issues in practice.

### HMAC (HS256)
Symmetric HMAC-SHA256 for evidence signing.

- **Rejected because:** HMAC uses a shared secret — the same key signs and verifies. This means the ROSIE Middleware would need the signing key to verify evidence, which also gives it the ability to forge evidence. This violates the separation of concerns required for a compliance validation system. Asymmetric signing (ES256) ensures the middleware can verify but never forge evidence.

### RSA (RS256)
RSA-based asymmetric signing with SHA-256.

- **Rejected because:** While RS256 provides the same asymmetric properties as ES256, RSA keys are significantly larger (2048-bit minimum vs. 256-bit for P-256) and signature sizes are larger (256 bytes vs. 64 bytes). For evidence files stored in git repositories and transmitted via API, the smaller key and signature sizes of ES256 are preferred. ES256 also provides equivalent security strength to RSA-3072 with better performance on modern hardware.

### Custom Signing Format
Proprietary signing scheme using raw cryptographic primitives.

- **Rejected because:** Custom cryptographic formats are a known anti-pattern in security engineering. They cannot be independently audited against published standards, they lack ecosystem tooling, and they create maintenance burden. Using an IETF standard (JWS/RFC 7515) with a NIST-approved algorithm (ECDSA P-256/FIPS 186-4) provides regulatory defensibility and ecosystem support that no custom format can match.
